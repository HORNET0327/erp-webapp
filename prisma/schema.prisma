// Prisma schema for ERP - Sensor/Cable Distribution (P&F, WAGO, MURR)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// Authentication & User Management
model User {
  id            String    @id @default(cuid())
  username      String?   @db.VarChar(64)
  email         String    @unique
  name          String?
  passwordHash  String
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions      Session[]
  userRoles     UserRole[]
  userInfo      UserInfo?
  salesOrders   SalesOrder[] @relation("SalesOrders")
  purchaseOrders PurchaseOrder[] @relation("PurchaseOrders")
  activityLogs  ActivityLog[]
}

model Role {
  id        String     @id @default(cuid())
  name      String     @unique
  label     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  userRoles UserRole[]
}

model UserRole {
  userId String
  roleId String

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserInfo {
  id             String    @id @default(cuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  employeeCode   String?   @unique
  departmentCode String?
  jobTitle       String?

  phone          String?
  mobile         String?
  email          String?

  addressLine1   String?
  addressLine2   String?
  city           String?
  state          String?
  postalCode     String?
  country        String?

  hireDate       DateTime?
  resignDate     DateTime?
  birthDate      DateTime?
  gender         String?   @db.VarChar(16)

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("User_Info")
}

// Master Data
model Brand {
  id        String   @id @default(cuid())
  code      String   @unique @db.VarChar(32)
  name      String   @db.VarChar(100)
  country   String?  @db.VarChar(50)
  website   String?  @db.VarChar(200)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     Item[]
}

model Category {
  id        String   @id @default(cuid())
  code      String   @unique @db.VarChar(32)
  name      String   @db.VarChar(100)
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  Category[] @relation("CategoryHierarchy")
  items     Item[]
}

model Customer {
  id           String   @id @default(cuid())
  code         String   @unique @db.VarChar(32)
  name         String   @db.VarChar(200)
  contactPerson String? @db.VarChar(100)
  email        String?  @db.VarChar(200)
  phone        String?  @db.VarChar(50)
  address      String?  @db.VarChar(500)
  notes        String?  @db.VarChar(1000)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  salesOrders SalesOrder[]
}

model Vendor {
  id           String   @id @default(cuid())
  code         String   @unique @db.VarChar(32)
  name         String   @db.VarChar(200)
  contactPerson String? @db.VarChar(100)
  email        String?  @db.VarChar(200)
  phone        String?  @db.VarChar(50)
  address      String?  @db.VarChar(500)
  notes        String?  @db.VarChar(1000)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
}

model Item {
  id          String   @id @default(cuid())
  code        String   @unique @db.VarChar(64)
  name        String   @db.VarChar(200)
  uom         String?  @db.VarChar(32)
  categoryId  String?
  brandId     String?
  model       String?  @db.VarChar(100)
  spec        String?  @db.VarChar(500)
  hasSerial   Boolean  @default(false)
  minStock    Decimal? @db.Decimal(18,2)
  basePrice   Decimal? @db.Decimal(18,2)
  leadTime    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category    Category? @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  brand       Brand?    @relation(fields: [brandId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  soLines     SalesOrderLine[]
  poLines     PurchaseOrderLine[]
  invTx       InventoryTransaction[]
  serials     SerialNumber[]
}

model Warehouse {
  id        String   @id @default(cuid())
  code      String   @unique @db.VarChar(32)
  name      String   @db.VarChar(200)
  address   String?  @db.VarChar(500)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invTx     InventoryTransaction[]
}

// Sales
model SalesOrder {
  id            String   @id @default(cuid())
  orderNo       String   @unique @db.VarChar(32)
  customerId    String
  salespersonId String?
  orderDate     DateTime
  requiredDate  DateTime?
  status        String   @db.VarChar(16) // OPEN, CLOSED, CANCELLED, PENDING
  totalAmount   Decimal  @db.Decimal(18,2)
  notes         String?  @db.VarChar(500)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  customer      Customer @relation(fields: [customerId], references: [id])
  salesperson   User?    @relation("SalesOrders", fields: [salespersonId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  lines         SalesOrderLine[]
}

model SalesOrderLine {
  id           String   @id @default(cuid())
  salesOrderId String
  itemId       String
  qty          Decimal  @db.Decimal(18,2)
  unitPrice    Decimal  @db.Decimal(18,2)
  amount       Decimal  @db.Decimal(18,2)

  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  item         Item       @relation(fields: [itemId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([salesOrderId])
}

// Purchase
model PurchaseOrder {
  id         String   @id @default(cuid())
  poNo       String   @unique @db.VarChar(32)
  vendorId   String
  buyerId    String?
  orderDate  DateTime
  requiredDate DateTime?
  status     String   @db.VarChar(16) // OPEN, CLOSED, CANCELLED, PENDING
  totalAmount Decimal @db.Decimal(18,2)
  notes      String?  @db.VarChar(500)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  vendor     Vendor @relation(fields: [vendorId], references: [id])
  buyer      User?  @relation("PurchaseOrders", fields: [buyerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  lines      PurchaseOrderLine[]
}

model PurchaseOrderLine {
  id              String   @id @default(cuid())
  purchaseOrderId String
  itemId          String
  qty             Decimal  @db.Decimal(18,2)
  unitCost        Decimal  @db.Decimal(18,2)
  amount          Decimal  @db.Decimal(18,2)

  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item            Item          @relation(fields: [itemId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([purchaseOrderId])
}

// Inventory
model InventoryTransaction {
  id          String   @id @default(cuid())
  itemId      String
  warehouseId String
  txDate      DateTime
  txType      String   @db.VarChar(16) // RECEIPT, ISSUE, ADJUST, TRANSFER
  qty         Decimal  @db.Decimal(18,2)
  unitCost    Decimal  @db.Decimal(18,2)
  serialNo    String?  @db.VarChar(100)
  lotNo       String?  @db.VarChar(50)
  expiryDate  DateTime?
  reference   String?  @db.VarChar(100)
  notes       String?  @db.VarChar(500)

  item        Item      @relation(fields: [itemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([itemId, warehouseId])
  @@index([serialNo])
  @@index([lotNo])
}

model SerialNumber {
  id          String   @id @default(cuid())
  itemId      String
  serialNo    String   @unique @db.VarChar(100)
  status      String   @db.VarChar(16) // AVAILABLE, SOLD, RETURNED, DEFECTIVE
  soldDate    DateTime?
  soldTo      String?  @db.VarChar(100)
  warrantyExp DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  item        Item @relation(fields: [itemId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([itemId])
  @@index([status])
}

// Activity Log
model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   @db.VarChar(50) // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entityType  String   @db.VarChar(50) // ORDER, ITEM, CUSTOMER, VENDOR, etc.
  entityId    String?  @db.VarChar(50)
  description String   @db.VarChar(500)
  metadata    String?  @db.VarChar(1000) // JSON string for additional data
  timestamp   DateTime @default(now())

  user        User @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([userId])
  @@index([timestamp])
  @@index([action])
  @@index([entityType])
}