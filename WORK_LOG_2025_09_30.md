# 📝 작업 로그 - 2025년 9월 30일

## 🎯 작업 목표
구매요청 기능을 완성하고, 히스토리 시스템을 구현하여 사용자가 구매요청의 모든 변경 사항을 추적할 수 있도록 개선

---

## 🔧 주요 작업 내용

### 1. 구매요청 상세보기 기능 구현

**문제점**: 
- 구매요청 목록에서 아이템을 클릭하면 구매주문 상세보기가 나타남
- 구매사유, 비고, 품목별 사유가 표시되지 않음

**해결책**:
- `PurchaseRequestDetailModal.tsx` 새로 생성
- 구매요청 전용 상세보기 화면 구현
- 구매사유, 비고, 품목별 사유 필드 추가
- 요청자/승인자 정보 표시 개선

### 2. 구매요청 히스토리 시스템 구현

**문제점**:
- 구매요청 히스토리 조회 시 404 오류 발생
- 히스토리에 아무 내용도 표시되지 않음

**해결책**:
- 구매요청 전용 히스토리 API 생성 (`/api/purchase-requests/[id]/history`)
- 상세 변경 내역을 시각적으로 표시 (빨간색 취소선 + 초록색 새 값)
- 승인/거부 시 어떤 데이터가 어떻게 변경되었는지 자동 기록

**기록되는 정보**:
- 상태 변경: 요청대기 → 승인됨/거부됨
- 승인자/거부자 정보
- 승인/거부 일시
- 거부 사유 (거부 시)
- 공급업체, 요청자, 총 금액, 품목 수 등

### 3. 데이터베이스 스키마 수정

**문제점**:
- `Foreign key constraint violated` 오류 발생
- PurchaseRequest와 PurchaseOrder 간 관계 설정 오류

**해결책**:
- Prisma 스키마에서 잘못된 관계 정의 수정
- `PurchaseRequest`의 `convertedTo` 필드를 올바른 관계로 변경
- `npx prisma db push`로 데이터베이스 스키마 업데이트

### 4. 활동 로그 시스템 개선

**문제점**:
- `logActivity` 함수에서 401 Unauthorized 오류 발생
- 구매요청 생성 시 히스토리가 기록되지 않음

**해결책**:
- API 호출 대신 직접 Prisma를 사용하도록 변경
- `userId` 필드 누락 문제 해결
- 구매요청 생성/승인/거부 시 자동 히스토리 기록

### 5. UI/UX 개선사항

**구매요청 상세보기**:
- 요청항목 테이블에 "사유" 컬럼 추가
- "단가" → "요청단가"로 라벨 변경
- 요청자/승인자 정보 표시 개선

**히스토리 모달**:
- 변경 내역을 시각적으로 표시
- 과거값과 새 값을 색상으로 구분
- 구매요청 관련 상세 정보 표시

### 6. 테스트 및 디버깅

**테스트 데이터 추가**:
- 기존 구매요청들에 샘플 히스토리 데이터 추가
- 생성, 승인, 거부 히스토리 예시 제공

**디버깅 기능**:
- API와 모달에서 실제 데이터 확인 가능한 로그 추가
- 오류 발생 시 상세한 정보 출력

---

## 📊 작업 결과

### 새로 생성된 파일
- `src/components/PurchaseRequestDetailModal.tsx` - 구매요청 상세보기 모달
- `src/app/api/purchase-requests/[id]/route.ts` - 구매요청 상세 조회 API
- `src/app/api/purchase-requests/[id]/history/route.ts` - 구매요청 히스토리 API

### 수정된 파일
- `src/app/api/purchase-requests/route.ts` - 구매요청 생성 API
- `src/app/api/purchase-requests/[id]/approve/route.ts` - 구매요청 승인 API
- `src/app/api/purchase-requests/[id]/reject/route.ts` - 구매요청 거부 API
- `src/components/HistoryModal.tsx` - 히스토리 모달 개선
- `src/lib/activity-logger.ts` - 활동 로그 시스템 개선
- `prisma/schema.prisma` - 데이터베이스 스키마 수정

### 주요 기능
- ✅ 구매요청 상세보기 완성
- ✅ 히스토리 시스템 구현
- ✅ 상세 변경 내역 추적
- ✅ 자동 히스토리 기록
- ✅ 데이터베이스 오류 해결

---

## 🎯 사용자 경험 개선

이제 사용자는:
1. 구매요청의 모든 변경 사항을 추적할 수 있습니다
2. 누가 언제 무엇을 변경했는지 상세하게 확인할 수 있습니다
3. 구매사유, 비고, 품목별 사유 등 모든 정보를 한눈에 볼 수 있습니다
4. 승인/거부 과정에서 발생한 모든 변경 내역을 시각적으로 확인할 수 있습니다

---

## 🔗 관련 커밋
- **커밋 해시**: `52a539a`
- **브랜치**: `HO1`
- **변경된 파일**: 14개 (1,677줄 추가, 288줄 삭제)
